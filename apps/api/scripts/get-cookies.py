#!/usr/bin/env python3
"""
è‡ªåŠ¨è·å–æŠ–éŸ³ cookies
ä½¿ç”¨ Playwright æ§åˆ¶ Chrome å¹¶å¯¼å‡º cookies
"""

import asyncio
import sys
import os

async def get_douyin_cookies():
    from playwright.async_api import async_playwright
    
    cookies_path = "/Volumes/movespace/workspace/Auto-home-sale-media-creator/apps/api/cookies/douyin.txt"
    
    async with async_playwright() as p:
        # ä½¿ç”¨ç³»ç»Ÿå·²å®‰è£…çš„ Chrome
        browser = await p.chromium.launch(
            headless=False,
            executable_path='/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',
            args=['--disable-blink-features=AutomationControlled']
        )
        
        context = await browser.new_context(
            viewport={'width': 1280, 'height': 800}
        )
        
        page = await context.new_page()
        
        print("ğŸš€ æ‰“å¼€æŠ–éŸ³ç½‘é¡µç‰ˆ...")
        try:
            await page.goto("https://www.douyin.com/", timeout=60000)
        except:
            pass  # è¶…æ—¶ä¹Ÿç»§ç»­
        
        # ç­‰å¾…é¡µé¢åŠ è½½
        await asyncio.sleep(5)
        
        # æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        try:
            # å¯»æ‰¾ç™»å½•åçš„å…ƒç´ ï¼ˆå¤´åƒï¼‰
            avatar = await page.wait_for_selector("[data-e2e='user-avatar']", timeout=5000)
            if avatar:
                print("âœ… æ£€æµ‹åˆ°å·²ç™»å½•çŠ¶æ€")
            else:
                print("âš ï¸  æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œè¯·æ‰‹åŠ¨ç™»å½•")
                print("â³ ç­‰å¾…60ç§’è®©ä½ ç™»å½•...")
                await asyncio.sleep(60)
        except:
            print("âš ï¸  æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œè¯·æ‰‹åŠ¨ç™»å½•")
            print("â³ ç­‰å¾…60ç§’è®©ä½ ç™»å½•...")
            await asyncio.sleep(60)
        
        # è·å– cookies
        cookies = await context.cookies()
        
        # æ ¼å¼åŒ–ä¸º Netscape HTTP Cookie File æ ¼å¼
        cookie_lines = [
            "# Netscape HTTP Cookie File",
            "# Generated by Playwright",
            "# Edit at your own risk",
            ""
        ]
        
        for cookie in cookies:
            domain = cookie['domain']
            flag = "TRUE" if domain.startswith('.') else "FALSE"
            path = cookie['path']
            secure = "TRUE" if cookie['secure'] else "FALSE"
            expiration = str(cookie.get('expires', 0))
            name = cookie['name']
            value = cookie['value']
            
            cookie_lines.append(f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}")
        
        # ä¿å­˜ cookies
        os.makedirs(os.path.dirname(cookies_path), exist_ok=True)
        with open(cookies_path, 'w') as f:
            f.write('\n'.join(cookie_lines))
        
        print(f"âœ… Cookies å·²ä¿å­˜åˆ°: {cookies_path}")
        print(f"ğŸ“Š å…± {len(cookies)} ä¸ª cookies")
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«å…³é”® cookie
        cookie_names = [c['name'] for c in cookies]
        important = ['sessionid', 'sid_guard', 'ttwid', 'msToken']
        found = [n for n in important if n in cookie_names]
        print(f"ğŸ”‘ å…³é”® cookies: {found}")
        
        await browser.close()
        return True

if __name__ == "__main__":
    try:
        result = asyncio.run(get_douyin_cookies())
        sys.exit(0 if result else 1)
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        sys.exit(1)
